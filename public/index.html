<!DOCTYPE html>
<html>
<head>
    <title>ESP32 Live Data</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .container { display: flex; gap: 50px; }
        .box { width: 100px; text-align: center; }
        .bar-container { width: 40px; height: 200px; border: 2px solid #ccc; position: relative; margin: auto; }
        .bar-fill { position: absolute; bottom: 0; width: 100%; background-color: green; height: 0; transition: height 0.5s, background-color 0.5s; }
        .value { margin-top: 5px; font-weight: bold; }
        .status { margin-top: 5px; font-weight: bold; }
    </style>
</head>
<body>

<h1>ESP32 Live Sensor Data</h1>

<div class="container">
    <div class="box">
        <div class="bar-container">
            <div id="temp-bar" class="bar-fill"></div>
        </div>
        <div class="value" id="temp">Loading...</div>
        <div class="status" id="temp-status"></div>
    </div>

    <div class="box">
        <div class="bar-container">
            <div id="hum-bar" class="bar-fill" style="background-color: blue;"></div>
        </div>
        <div class="value" id="hum">Loading...</div>
    </div>
</div>

<div class="value">
    Fan Status: <span id="fan">Loading...</span>
</div>

<script>
let lastUpdate = Date.now();

function updateData() {
    fetch("/api/data")
        .then(res => res.json())
        .then(data => {
            if (!data.temperature && !data.humidity) return;

            lastUpdate = Date.now();

            // Temperature
            let temp = data.temperature;
            let temp_limit = data.temp_limit || 30;
            document.getElementById("temp").innerText = temp.toFixed(1) + " °C";

            // Status text & color
            let statusText = "Low";
            let color = "green";
            if (temp >= temp_limit) {
                statusText = "High";
                color = "red";
            } else if (temp >= temp_limit / 2) {
                statusText = "Mid";
                color = "orange";
            }
            document.getElementById("temp-status").innerText = statusText;
            document.getElementById("temp-bar").style.backgroundColor = color;

            // Fill bar height (relative to max 50°C)
            let tempHeight = Math.min((temp / 50) * 100, 100);
            document.getElementById("temp-bar").style.height = tempHeight + "%";

            // Humidity
            let hum = data.humidity;
            document.getElementById("hum").innerText = hum.toFixed(1) + " %";
            let humHeight = Math.min((hum / 100) * 100, 100);
            document.getElementById("hum-bar").style.height = humHeight + "%";

            // Fan status
            document.getElementById("fan").innerText = data.fan ? "ON" : "OFF";

        })
        .catch(err => console.log("Error:", err));
}

// Check if data is stale (>10s)
function checkLoading() {
    if (Date.now() - lastUpdate > 10000) {
        document.getElementById("temp").innerText = "Loading...";
        document.getElementById("hum").innerText = "Loading...";
        document.getElementById("fan").innerText = "Loading...";
        document.getElementById("temp-status").innerText = "";
        document.getElementById("temp-bar").style.height = "0";
        document.getElementById("hum-bar").style.height = "0";
    }
}

setInterval(updateData, 1000);
setInterval(checkLoading, 2000);
updateData();
</script>

</body>
</html>
